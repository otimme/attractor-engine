digraph dark_factory {
    graph [
        goal="",
        label="Dark Factory"
    ]
    rankdir=TB

    start [shape=Mdiamond, label="Start"]
    exit  [shape=Msquare,  label="Exit"]

    spec_validate [label="Spec Validation",
        type="sub_pipeline",
        sub_pipeline="pipelines/dark-factory/spec-validate.dot"]

    dev_agent_ios [label="Dev Agent (iOS)",
        type="sub_pipeline",
        sub_pipeline="pipelines/dark-factory/dev-agent-ios.dot",
        max_visits=5]

    test_agent [label="Test Agent",
        type="sub_pipeline",
        sub_pipeline="pipelines/dark-factory/test-agent.dot",
        max_visits=5]

    judge [label="Judge",
        prompt="@prompts/judge/score.md",
        max_visits=5]

    holdout [label="Holdout Gate",
        type="sub_pipeline",
        sub_pipeline="pipelines/dark-factory/holdout.dot"]

    start -> spec_validate
    spec_validate -> dev_agent_ios
    dev_agent_ios -> test_agent
    test_agent -> judge
    judge -> dev_agent_ios [condition="outcome!=success", label="Not converged"]
    judge -> holdout       [condition="outcome=success",  label="Converged"]
    holdout -> exit
}
